<template>
    <div class="h-full flex flex-col bg-neutral-100" v-if="site">
        <div class="bg-white border-b">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <Button variant="outline" @click="$router.go(-1)" class="h-9 w-9">
                        <ArrowLeft :size="20" />
                    </Button>
                </div>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <div class="w-full lg:w-1/4 xl:w-[500px] bg-white border-r overflow-y-auto">
                <div class="p-6">
                    <h2 class="text-lg font-semibold text-neutral-900 mb-4">Informations générales</h2>

                    <form @submit.prevent="saveSite" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-neutral-700">Nom du site</label>
                            <Input v-model="siteForm.name" class="mt-1" />
                        </div>

                        <div>
                            <label class="text-sm font-medium text-neutral-700">Type de bâtiment</label>
                            <Select v-model="siteForm.building_type" class="mt-1">
                                <SelectTrigger class="w-full">
                                    <SelectValue placeholder="Sélectionner un type" />
                                </SelectTrigger>
                                <SelectContent>
                                    <SelectItem v-for="option in getSiteBuildingTypeOptions()" :key="option.value"
                                        :value="option.value">
                                        {{ option.label }}
                                    </SelectItem>
                                </SelectContent>
                            </Select>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-neutral-700">Entreprise associée</label>
                            <div class="mt-1">
                                <CompanySelect v-model="siteForm.company" placeholder="Sélectionner une entreprise..."
                                    clearable />
                            </div>
                        </div>

                        <Separator class="my-6" />

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-neutral-700">Adresse</label>
                                <Input v-model="siteForm.street" class="mt-1" />
                            </div>

                            <div>
                                <label class="text-sm font-medium text-neutral-700">Complément d'adresse</label>
                                <Input v-model="siteForm.street_2" class="mt-1" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-neutral-700">Code postal</label>
                                <Input v-model="siteForm.zip" class="mt-1" />
                            </div>

                            <div>
                                <label class="text-sm font-medium text-neutral-700">Ville</label>
                                <Input v-model="siteForm.city" class="mt-1" />
                            </div>
                        </div>

                        <div>
                            <label class="text-sm font-medium text-neutral-700">Pays</label>
                            <div class="mt-1">
                                <CountrySelect v-model="siteForm.country" placeholder="Sélectionner un pays..."
                                    clearable />
                            </div>
                        </div>

                        <Separator class="my-6" />

                        <div>
                            <label class="text-sm font-medium text-neutral-700">Informations d'accès</label>
                            <Textarea v-model="siteForm.access_info" class="mt-1" rows="3"
                                placeholder="Code portail, interphone, instructions d'accès..." />
                        </div>

                        <div class="flex justify-end pt-4">
                            <Button type="submit" :disabled="loading">
                                {{ loading ? 'Enregistrement...' : 'Enregistrer' }}
                            </Button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="flex-1 bg-neutral-50 overflow-y-auto">
                <div class="p-6">
                    <div class="bg-white mb-4 rounded-lg border">
                        <div class="p-6">
                            <div class="flex items-start justify-between">
                                <div class="flex items-start space-x-2">
                                    <MapPinIcon class="h-8 w-8 text-neutral-400 mt-2 me-3" :stroke-width="1.2" />
                                    <div class="flex flex-col gap-1">
                                        <h1 class="text-2xl font-semibold">{{ site.name }}</h1>
                                        <div class="flex gap-2">
                                            <Badge variant="outline">
                                                <Building class="h-4 w-4" />
                                                {{ getSiteBuildingTypeLabel(site.building_type) }}
                                            </Badge>
                                            <Badge variant="outline" v-if="site.company">
                                                <Building2 class="h-4 w-4" />
                                                {{ site.company.name }}
                                            </Badge>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="text-2xl font-semibold text-neutral-900">{{ kpis.totalLots }}</div>
                            <div class="text-sm text-neutral-600">Lots/Logements</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="text-2xl font-semibold text-neutral-900">{{ kpis.totalEquipments }}</div>
                            <div class="text-sm text-neutral-600">Équipements</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="text-2xl font-semibold text-neutral-900">{{ kpis.totalInterventions }}</div>
                            <div class="text-sm text-neutral-600">Interventions</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border">
                            <div class="text-2xl font-semibold text-neutral-900">{{ kpis.totalDocuments }}</div>
                            <div class="text-sm text-neutral-600">Documents</div>
                        </div>
                    </div>

                    <Tabs default-value="lots" class="w-full">
                        <TabsList class="grid w-full grid-cols-3 mb-3 bg-neutral-200">
                            <TabsTrigger value="lots" class="flex items-center space-x-2">
                                <Building class="h-4 w-4" />
                                <span>Lots</span>
                            </TabsTrigger>
                            <TabsTrigger value="equipments" class="flex items-center space-x-2">
                                <Wrench class="h-4 w-4" />
                                <span>Équipements</span>
                            </TabsTrigger>
                            <TabsTrigger value="documents" class="flex items-center space-x-2">
                                <FileText class="h-4 w-4" />
                                <span>Documents</span>
                            </TabsTrigger>
                        </TabsList>

                        <TabsContent value="lots">
                            <div class="bg-white rounded-lg border">
                                <div class="px-6 py-4 border-b">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-semibold text-neutral-900">Lots</h3>
                                        <Button size="sm">
                                            <Plus class="h-4 w-4" />
                                            Ajouter un lot
                                        </Button>
                                    </div>
                                </div>
                                <div class="p-6 text-center text-neutral-500">
                                    <Building class="h-12 w-12 mx-auto mb-4 text-neutral-300" />
                                    <p>Fonctionnalité à venir</p>
                                    <p class="text-sm">Les lots et logements seront bientôt disponibles</p>
                                </div>
                            </div>
                        </TabsContent>

                        <TabsContent value="equipments">
                            <div class="bg-white rounded-lg border">
                                <div class="px-6 py-4 border-b">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-semibold text-neutral-900">Équipements</h3>
                                        <Button size="sm">
                                            <Plus class="h-4 w-4" />
                                            Ajouter un équipement
                                        </Button>
                                    </div>
                                </div>
                                <div class="p-6 text-center text-neutral-500">
                                    <Wrench class="h-12 w-12 mx-auto mb-4 text-neutral-300" />
                                    <p>Fonctionnalité à venir</p>
                                    <p class="text-sm">La gestion des équipements sera bientôt disponible</p>
                                </div>
                            </div>
                        </TabsContent>

                        <TabsContent value="documents">
                            <div class="bg-white rounded-lg border">
                                <div class="px-6 py-4 border-b">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-lg font-semibold text-neutral-900">Documents</h3>
                                        <Button size="sm">
                                            <Plus class="h-4 w-4" />
                                            Ajouter un document
                                        </Button>
                                    </div>
                                </div>
                                <div class="p-6 text-center text-neutral-500">
                                    <FileText class="h-12 w-12 mx-auto mb-4 text-neutral-300" />
                                    <p>Fonctionnalité à venir</p>
                                    <p class="text-sm">La gestion documentaire sera bientôt disponible</p>
                                </div>
                            </div>
                        </TabsContent>
                    </Tabs>
                </div>
            </div>
        </div>
    </div>

    <div v-else-if="loading" class="h-full flex items-center justify-center">
        <div class="text-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-neutral-900 mx-auto mb-4"></div>
            <p class="text-neutral-600">Chargement du site...</p>
        </div>
    </div>

    <div v-else class="h-full flex items-center justify-center">
        <div class="text-center">
            <MapPin class="h-12 w-12 mx-auto mb-4 text-neutral-300" />
            <p class="text-neutral-600">Site non trouvé</p>
            <Button @click="$router.go(-1)" class="mt-4">Retour</Button>
        </div>
    </div>
</template>

<script setup>
import { CompanySelect } from '@/common/components/form/company-select'
import { CountrySelect } from '@/common/components/form/country-select'
import { Button } from '@/common/components/ui/button'
import { Input } from '@/common/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/common/components/ui/select'
import { Separator } from '@/common/components/ui/separator'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/common/components/ui/tabs'
import { Textarea } from '@/common/components/ui/textarea'
import { useFetcher } from '@/common/composables/fetcher'
import { useSite } from '@/common/composables/useSite'
import {
    ArrowLeft,
    Building,
    Building2,
    FileText,
    MapPin,
    MapPinIcon,
    Plus,
    Wrench
} from 'lucide-vue-next'
import { onMounted, reactive, ref } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { toast } from 'vue-sonner'
import Badge from '../../../common/components/ui/badge/Badge.vue'

const route = useRoute()
const router = useRouter()
const fetcher = useFetcher()
const { getSiteBuildingTypeLabel, getSiteBuildingTypeOptions } = useSite()

const site = ref(null)
const loading = ref(false)
const siteId = route.params.id

const siteForm = reactive({
    name: '',
    building_type: '',
    street: '',
    street_2: '',
    zip: '',
    city: '',
    access_info: ''
})

const kpis = reactive({
    totalLots: 0,
    totalEquipments: 0,
    totalInterventions: 0,
    totalDocuments: 0
})

const fetchSite = async () => {
    if (!siteId) return

    loading.value = true
    try {
        const response = await fetcher.get(`/sites/${siteId}`)
        site.value = response.data

        Object.assign(siteForm, {
            name: site.value.name || '',
            building_type: site.value.building_type || '',
            street: site.value.street || '',
            street_2: site.value.street_2 || '',
            zip: site.value.zip || '',
            city: site.value.city || '',
            access_info: site.value.access_info || '',
            company: site.value.company || null,
            country: site.value.country || null
        })

        kpis.totalLots = 0
        kpis.totalEquipments = 0
        kpis.totalInterventions = 0
        kpis.totalDocuments = 0

    } catch (error) {
        console.error('Erreur lors du chargement du site:', error)
        toast.error('Erreur lors du chargement du site')
    } finally {
        loading.value = false
    }
}

const saveSite = async () => {
    if (!site.value) return

    loading.value = true
    try {
        const updateData = {
            ...siteForm,
            company: siteForm.company?.id || null,
            country: siteForm.country?.id || null
        }

        const response = await fetcher.patch(`/sites/${site.value.id}`, updateData)
        site.value = response.data
        toast.success('Site mis à jour avec succès')
    } catch (error) {
        console.error('Erreur lors de la sauvegarde:', error)
        toast.error('Erreur lors de la sauvegarde')
    } finally {
        loading.value = false
    }
}

onMounted(() => {
    fetchSite()
})
</script>